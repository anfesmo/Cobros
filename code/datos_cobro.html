<!DOCTYPE HTML>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta name="viewport" content="user-scalable=no, initial-scale=1.0, maximum-scale=1.0" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <title>Gestion Cobros</title>
    <link href="styles/style.css" rel="stylesheet" type="text/css">
    <link href="styles/framework.css" rel="stylesheet" type="text/css">
    <link href="styles/owl.carousel.css" rel="stylesheet" type="text/css">
    <link href="styles/owl.theme.css" rel="stylesheet" type="text/css">
    <link href="styles/swipebox.css" rel="stylesheet" type="text/css">
    <link href="styles/colorbox.css" rel="stylesheet" type="text/css">
    <style>
        .star
        {
            display: inline;
            background-image: url(../images/misc/facebook.png);
            width: 30px;
            margin: 0px 0px 0px 47px;
        }
		.styled-select
        {
            width: 95%;
            height: 34px;
            overflow: hidden;
            background: url(images/flecha_abajo.png) no-repeat right #F4F4F4;
            padding: 3px;
            margin: 5px;
            -webkit-border-radius: 4px;
            -moz-border-radius: 4px;
            border-radius: 4px;
            -webkit-box-shadow: 0 3px 0 #ccc, 0 -1px #fff inset;
            -moz-box-shadow: 0 3px 0 #ccc, 0 -1px #fff inset;
            box-shadow: 0 3px 0 #ccc, 0 -1px #fff inset;
            color: #888;
            border: none;
            outline: none;
            display: inline-block;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            cursor: pointer;
        }

    </style>
    <script type="text/javascript" src="scripts/jquery.js"></script>
    <script type="text/javascript" src="scripts/jqueryui.js"></script>
    <script type="text/javascript" src="scripts/owl.carousel.min.js"></script>
    <script type="text/javascript" src="scripts/jquery.swipebox.js"></script>
    <script type="text/javascript" src="scripts/colorbox.js"></script>
    <script type="text/javascript" src="scripts/snap.js"></script>
    <script type="text/javascript" src="scripts/contact.js"></script>
    <script type="text/javascript" src="scripts/custom.js"></script>
    <script type="text/javascript" src="scripts/framework.js"></script>
    <script type="text/javascript" src="scripts/framework.launcher.js"></script>
    <script type="text/javascript" src="scripts/bd.js"></script>
</head>
<body>
    <div id="preloader">
        <div id="status">
            <p class="center-text">
                Cargando contenido... <em>La carga depende de su conexión a internet!</em>
            </p>
        </div>
    </div>
    <div class="all-elements">
        <div id="sidebar" class="page-sidebar">
            <div class="page-sidebar-scroll">
                <div class="sidebar-shortcuts">
                    <a href="#" class="shortcut-close"></a>
                </div>
                
                <div class="sidebar-search">
                    <div class="search-box">
                        <input type="text" class="search-field" name="search" onfocus="if(this.value == 'Looking for something?') { this.value = ''; }" value="Looking for something?">
                        <a href="#" class="search-close"></a>
                    </div>
                </div>
                
                <div class="sidebar-logo">
                    <img src="images/drugs/logo_odc.png" height="52" alt="img">
                </div>
                
                <div class="sidebar-breadcrumb">NAVEGACIÓN</div>
                <div class="navigation-item">
                    <a href="index.html" class="nav-item home-icon">Inicio<em class="selected-item"></em></a>
                </div>
                <div class="sidebar-decoration"></div>
                <div class="navigation-item">
                    <a href="inicio-sesion.html" class="nav-item home-locales">Sincronizar<em class="unselected-item"></em></a>
                </div>
                <div class="sidebar-decoration"></div>
                <div class="navigation-item">
                    <a href="registro_cliente.html" class="nav-item home-locales">Registrar cliente<em class="unselected-item"></em></a>
                </div>
				<div class="sidebar-decoration"></div>
				<div class="navigation-item">
                    <a href="lista_clientes.html" class="nav-item home-locales">Listado Clientes<em class="unselected-item"></em></a>
                </div>
				<div class="navigation-item">
                    <a href="reporte_preliquidacion.html" class="nav-item home-locales">Reporte Preliquidación<em class="unselected-item"></em></a>
                </div>
                <div class="sidebar-decoration"></div>
                
                <div class="sidebar-breadcrumb">
                </div>
            </div>         
          </div>
        <div id="content" class="page-content">
            <div class="page-header">
                <a href="#" class="deploy-sidebar"></a>
                <img class="header-logo" src="images/drugs/odc-texto.png" width="71" alt="img">
            </div>
            <div class="page-header-clear">
            </div>
            <div class="content">
                <div class="decoration">
                </div>
                <div class="container no-bottom" style="text-align: center;">
                    <h3>
                        DETALLE DEL CLIENTE</h3>
                </div>
                <div class="decoration">
                </div>
                <div class="container no-bottom">
                    <div class="big-notification blue-notification">
                        <h4 class="uppercase">
                            AYUDA</h4>
                        <a href="#" class="close-big-notification">x</a>
                        <p>
                            En este módulo encontrá la información detallada sobre el cliente seleccionado.
                        </p>
                    </div>
                </div>
                <div id ="detalleCliente">
                    <div class="formSubmitButtonErrorsWrap">
                            <input type="submit" class="buttonWrap button button-dark contactSubmitButton" id="contactSubmitButton"
                                value="Volver al listado de clientes" data-formid="contactForm" onclick="mostrarClientes();" />
                        </div>
                        <br />
                    <div class="container">
                        <div class="toggle-2">
                            <a href="#" class="deploy-toggle-2 toggle-2-active">
                                <label id="lblNombre"></label>
                            </a>
                            <div class="toggle-content" style="display:block;">
                                <div class="toggle-content" style="display:block;">
                                    <p><strong>Datos del prestamo:</strong></p>
                                    <div class="one-half-responsive ">
                                        <div class="submenu-navigation">
                                            <div class="submenu-nav-items" style="overflow: hidden; display: block;"></div>
                                            <a href="#" style="border-top: solid 1px rgba(0,0,0,0.1); padding-left: 20px !important; padding-top: 10px !important; padding-bottom: 10px !important; border-bottom: solid 1px rgba(0,0,0,0.1) !important;">
                                                <ul style="margin-bottom:0px;" class="icon-list">
                                                    <li class="right-list"><label id="lblValorPrestamo">Valor del prestamo: </label></li>
                                                </ul>
                                            </a>
                                            <a href="#" style="border-top: solid 1px rgba(0,0,0,0.1); padding-left: 20px !important; padding-top: 10px !important; padding-bottom: 10px !important; border-bottom: solid 1px rgba(0,0,0,0.1) !important;">
                                                <ul style="margin-bottom:0px;" class="icon-list">
                                                    <li class="right-list"><label id="lblFechaPrestamo">Fecha prestamo: </label></li>
                                                </ul>
                                            </a>
                                            <a href="#" style="border-top: solid 1px rgba(0,0,0,0.1); padding-left: 20px !important; padding-top: 10px !important; padding-bottom: 10px !important; border-bottom: solid 1px rgba(0,0,0,0.1) !important;">
                                                <ul style="margin-bottom:0px;" class="icon-list">
                                                    <li class="right-list"><label id="lblFechaVencimientoPrestamo">Fecha vencimiento: </label></li>
                                                </ul>
                                            </a>
                                            <a href="#" style="border-top: solid 1px rgba(0,0,0,0.1); padding-left: 20px !important; padding-top: 10px !important; padding-bottom: 10px !important; border-bottom: solid 1px rgba(0,0,0,0.1) !important;">
                                                <ul style="margin-bottom:0px;" class="icon-list">
                                                    <li class="right-list"><label id="lblNumeroCuotas">Número de cuotas del prestamo: </label></li>
                                                </ul>
                                            </a>
                                            <a href="#" style="border-top: solid 1px rgba(0,0,0,0.1); padding-left: 20px !important; padding-top: 10px !important; padding-bottom: 10px !important; border-bottom: solid 1px rgba(0,0,0,0.1) !important;">
                                                <ul style="margin-bottom:0px;" class="icon-list">
                                                    <li class="right-list"><label id="lblNumeroCuotasResta">Número de cuotas que resta: </label></li>
                                                </ul>
                                            </a>
                                            <a href="#" style="border-top: solid 1px rgba(0,0,0,0.1); padding-left: 20px !important; padding-top: 10px !important; padding-bottom: 10px !important; border-bottom: solid 1px rgba(0,0,0,0.1) !important;">
                                                <ul style="margin-bottom:0px;" class="icon-list">
                                                    <li class="right-list"><label id="lblValorCuota">Valor de la cuota: </label></li>
                                                </ul>
                                            </a>
                                            <a href="#" style="border-top: solid 1px rgba(0,0,0,0.1); padding-left: 20px !important; padding-top: 10px !important; padding-bottom: 10px !important; border-bottom: solid 1px rgba(0,0,0,0.1) !important;">
                                                <ul style="margin-bottom:0px;" class="icon-list">
                                                    <li class="right-list"><label id="lblValorInteres">Valor de los intereses: </label></li>
                                                </ul>
                                            </a>
                                            <a href="#" style="border-top: solid 1px rgba(0,0,0,0.1); padding-left: 20px !important; padding-top: 10px !important; padding-bottom: 10px !important; border-bottom: solid 1px rgba(0,0,0,0.1) !important;">
                                                <ul style="margin-bottom:0px;" class="icon-list">
                                                    <li class="right-list"><label id="lblSaldoCon">Valor del saldo con intereses: </label></li>
                                                </ul>
                                            </a>
                                            <a href="#" style="border-top: solid 1px rgba(0,0,0,0.1); padding-left: 20px !important; padding-top: 10px !important; padding-bottom: 10px !important; border-bottom: solid 1px rgba(0,0,0,0.1) !important;">
                                                <ul style="margin-bottom:0px;" class="icon-list">
                                                    <li class="right-list"><label id="lblSaldoSin">Valor del saldo sin intereses: </label></li>
                                                </ul>
                                            </a>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <br />
                    <div class="formSubmitButtonErrorsWrap">
                        <input type="submit" class="buttonWrap button button-dark contactSubmitButton" id="btnNuevoPrestamo" style="display: none !important;" value="Nuevo prestamo" onclick="crearPrestamo();" />
                    </div>
                    <div class="formSubmitButtonErrorsWrap">
                        <input type="submit" class="buttonWrap button button-dark contactSubmitButton" id="btnRecaudo" style="display: none !important;" value="Ingresar recaudo" onclick="crearRecaudo();" />
                    </div>
                </div>
                <div id="frmNuevoPrestamo" style="display: none;">
                    <form method="post" class="contactForm" id="contactForm" style="display: block !important;">
                    <fieldset>
                        <div class="formFieldWrap">
                            <label class="field-title contactNameField" for="contactNameField">
                                Valor del préstamo:<span>(requerido)</span></label>
                            <input type="number" name="contactNameField" value="" class="contactField requiredField"
                                id="txtValor" min="0" max="1000000" required autofocus  />
                        </div>
                        <div class="formFieldWrap">
                            <label class="field-title contactEmailField" for="contactEmailField">
                                Número de cuotas:<span>(requerido)</span></label>
                            <input type="number" name="contactEmailField" value="20" class="contactField requiredField"
                                id="txtCuotas" min="0" max="100" required />
                        </div>
                        <div class="formFieldWrap">
                            <label class="field-title contactEmailField" for="contactEmailField">
                                Valor del interés:<span>(requerido)</span></label>
                            <input type="number" name="contactEmailField" value="20" class="contactField requiredField"
                                id="txtInteres" min="0" max="100" required  />
                        </div>
                        <br />
                        <div class="formSubmitButtonErrorsWrap">
                            <input type="button" class="buttonWrap button button-dark contactSubmitButton" id="contactSubmitButton"
                                value="Guardar" data-formid="contactForm" onclick="guardarPrestamo();" />
                                <input type="button" class="buttonWrap button button-dark contactSubmitButton" id="contactSubmitButton"
                                value="Cancelar" data-formid="contactForm" onclick="cancelar();" />
                        </div>
                    </fieldset>
                    </form>
                </div>
                 <div id="frmRecaudo" style="display: none;">
                    
					<form method="post" class="contactForm" id="contactForm" style="display: block !important;">
                    <fieldset>
                        <div class="formFieldWrap">
                            <label class="field-title contactNameField" for="contactNameField">
                                Número de cuotas:<span>(requerido)</span></label>
                            <input type="number" name="contactNameField" value="" class="contactField requiredField"
                                id="txtNumeroCuotas" min="0" max="100" required autofocus/>
                        </div>
                        <div class="formFieldWrap">
                            <label class="field-title contactEmailField" for="contactEmailField">
                                Valor ajuste:<span>(requerido)</span></label>
                            <input type="number" name="contactEmailField" value="0" class="contactField requiredField"
                                id="txtAjuste" min="-1000000" max="1000000" step="0.01" required />
                        </div>
						<div class="formFieldWrap">
                            <label class="field-title contactNameField" for="contactNameField">
                                Observación:</label>
                            <select class="styled-select" name="selectObservacion" id="selectObservacion">
                                <option value='0'>Seleccionar</option>
								<option value='1'>No se encuentra en casa</option>
                                <option value='2'>Ya no vive en la dirección registrada</option>
                                <option value='3'>No va a pagar</option>                                
                            </select>
                        </div>
                        <br />
                        <div class="formSubmitButtonErrorsWrap">
                            <input type="button" class="buttonWrap button button-dark contactSubmitButton" id="contactSubmitButton"
                                value="Guardar" data-formid="contactForm" onclick="guardarRecaudo();" />
                                <input type="button" class="buttonWrap button button-dark contactSubmitButton" id="contactSubmitButton"
                                value="Cancelar" data-formid="contactForm" onclick="cancelar();" />
                        </div>
                    </fieldset>
                    </form>
					
                </div>
                <div class="decoration">
                </div>
                <div class="container">
                    <div class="footer-socials">
                        <a href="#" class="facebook-footer"></a><a href="#" class="goup-footer"></a><a href="#"
                            class="twitter-footer"></a>
                    </div>
                    <p class="copyright uppercase center-text no-bottom">
                        Gestión Cobros 2014<br>
                        Todos los derechos reservados</p>
                </div>
            </div>
        </div>
    </div>
    </div>
    <style>
        .submenu-nav-items a
        {
            padding-left: 20px !important;
            padding-top: 10px !important;
            padding-bottom: 10px !important;
            border-bottom: solid 1px rgba(0,0,0,0.1) !important;
        }
        
        .vinculo_derecha
        {
            float: right;
            padding-right: 1%;
        }
        
        .vinculo_izquierda
        {
            float: left;
            padding-left: 1%;
            display: none;
        }
    </style>
    <script>


        function mostrarClientes() {
            location.href = "lista_clientes.html";
        }

        function consultarCliente(){
            var db = window.openDatabase("bd_cobros", "1.0", "Gestion cobros", 200000);
            db.transaction(consultar_cliente, errorGeneralBD, function () {
                //console.log("Consultó el usuario")
            });
        }

        function consultar_cliente(tx) {
            tx.executeSql("SELECT * FROM clientes WHERE CodCliente = '"+localStorage.getItem("clienteConsultado")+"' order by VlrPrestamo desc", [], llenar_cliente, function (error) {
                //console.log("Error consultado el usuario: " + error)
            });
        }

        function llenar_cliente(tx, results) {
            var len = results.rows.length;
            if (len > 0) {
                for (var i = 0; i < 1; i++) {
                    document.getElementById("lblNombre").innerHTML = results.rows.item(i).Nombre;
                    document.getElementById("lblValorPrestamo").innerHTML = document.getElementById("lblValorPrestamo").innerHTML + results.rows.item(i).VlrPrestamo;
                    document.getElementById("lblFechaPrestamo").innerHTML = document.getElementById("lblFechaPrestamo").innerHTML+results.rows.item(i).FechaPrestamo;
                    document.getElementById("lblFechaVencimientoPrestamo").innerHTML = document.getElementById("lblFechaVencimientoPrestamo").innerHTML +results.rows.item(i).FechaVencimientoPrestamo;
                    document.getElementById("lblNumeroCuotas").innerHTML = document.getElementById("lblNumeroCuotas").innerHTML+results.rows.item(i).NroCuotasPrestamo;
                    document.getElementById("lblNumeroCuotasResta").innerHTML = document.getElementById("lblNumeroCuotasResta").innerHTML+results.rows.item(i).NroCuotasResta;
                    document.getElementById("lblValorCuota").innerHTML = document.getElementById("lblValorCuota").innerHTML+results.rows.item(i).VlrCuota;
                    document.getElementById("lblValorInteres").innerHTML = document.getElementById("lblValorInteres").innerHTML+results.rows.item(i).VlrIntreses;
                    document.getElementById("lblSaldoCon").innerHTML = document.getElementById("lblSaldoCon").innerHTML +results.rows.item(i).VlrSaldoConInteres;
                    document.getElementById("lblSaldoSin").innerHTML = document.getElementById("lblSaldoSin").innerHTML +results.rows.item(i).VlrSaldoSinInteres;
                    if(results.rows.item(i).VlrPrestamo == 0){
                        $('#btnNuevoPrestamo').show();
                        
                        document.getElementById("btnRecaudo").style.display = "none !important";
                        //$('#btnRecaudo').hide();
                    }
                    else{
                        $('#btnNuevoPrestamo').hide();
                        if(results.rows.item(i).esNuevo == "0"){
                            if(localStorage.getItem("codigoAnterior") != localStorage.getItem("clienteConsultado")){
                                $('#btnRecaudo').show();
                            }
                        }
                        localStorage.setItem("codPrestamo", results.rows.item(i).CodPrestamo);
                        localStorage.setItem("valSaldo", results.rows.item(i).VlrSaldoConInteres);
                        localStorage.setItem("valCuota", results.rows.item(i).VlrCuota);
                    }
                        
                }
            }
            else {
                alert("No se encontró información del cliente.");
                //location.reload();
            }
        }

        function errorGeneralBD(err) {
            console.log(err);
        }

        function crearPrestamo(){
            $('#frmNuevoPrestamo').show();
            $('#detalleCliente').hide();
            $('#frmRecaudo').hide();
        }

        function crearRecaudo(){
            $('#frmNuevoPrestamo').hide();
            $('#detalleCliente').hide();
            $('#frmRecaudo').show();
        }

        function cancelar(){
            $('#frmNuevoPrestamo').hide();
            $('#detalleCliente').show();
            $('#frmRecaudo').hide();
        }

        function guardarPrestamo(){
            if($('#txtValor').val() == ""){
                    alert("Debe ingresar un valor del préstamo.")
            }
            else{
                if($('#txtCuotas').val() == ""){
                    alert("Debe ingresar un número de cuotas.")
                }
                else{
                    if($('#txtInteres').val() == ""){
                        alert("Debe ingresar un valor del interés.")
                    }
                    else{
                        var db = window.openDatabase("bd_cobros", "1.0", "Gestion cobros", 200000);
                        db.transaction(guardar_prestamo, errorGeneralBD, function () {
                            //console.log("Consultó el usuario")
                        });
                    }
                }
            }
        }

        function guardar_prestamo(tx) {
            //codigo cliente, valor prestamo, fecha, numero cuotas, interés, codigo gestor
            var f = new Date();
            var fecha= f.getFullYear()+ "/" + (f.getMonth() +1) + "/" + f.getDate() + " " + f.getHours() + ":" + f.getMinutes()+":00";
            tx.executeSql("INSERT INTO clientes (CodCliente, Nombre, Telefono, NroIdentificacion, CodGestor, CodPrestamo, FechaPrestamo, FechaVencimientoPrestamo, NroCuotasPrestamo, NroCuotasResta, VlrCuota, VlrIntreses, VlrPrestamo, VlrSaldoConInteres, VlrSaldoSinInteres, esNuevo, Latitud, Longitud) VALUES ('"+localStorage.getItem("clienteConsultado")+"', '"+document.getElementById("lblNombre").innerHTML+"', '', '', '"+localStorage.getItem("idGestor")+"', '', '"+fecha+"', '', '"+$('#txtCuotas').val()+"', '', '', '"+$('#txtInteres').val()+"', '"+$('#txtValor').val()+"', '', '', '1', '"+localStorage.getItem("latitud")+"', '"+localStorage.getItem("longitud")+"')");
            location.href=location.href;
        }

        function guardarRecaudo(){
            //fecha, numero cuota, valor ajuste
            // validar que el numero de cuotas por el valor de la cuota no supere el saldo que queda por pagar            
			if($('#selectObservacion').val() == "" && $('#txtNumeroCuotas').val() == "0"){
				alert("Si el recaudo es igual a cero, debe seleccionar una de las observaciones listadas.")
			}else{
				if($('#txtNumeroCuotas').val() == ""){
						alert("Debe ingresar un número de cuotas.")
				}
				else{
					var ajuste=0;
					if($('#txtAjuste').val() != ""){
						ajuste = $('#txtAjuste').val();
					}
					var numCuotas =$('#txtNumeroCuotas').val();
					var valorCuota = localStorage.getItem("valCuota");					
					var saldoDefinitivo = parseFloat(localStorage.getItem("valSaldo")) - ((parseInt(numCuotas) * parseFloat(valorCuota)) + parseInt(ajuste));					
					if(saldoDefinitivo>=0){
						var db = window.openDatabase("bd_cobros", "1.0", "Gestion cobros", 200000);
						db.transaction(guardar_recaudo, errorGeneralBD, function () {
							console.log("Consultó el usuario")
						});
					}
					else{
						alert("El valor del recaudo es superior al saldo, verifique los datos.");
					}
				}
			}
        }
        

        function guardar_recaudo(tx) {
            //codigo cliente, valor prestamo, fecha, numero cuotas, interés, codigo gestor
            var f = new Date();
            var fecha= f.getFullYear()+ "/" + (f.getMonth() +1) + "/" + f.getDate() + " " +  f.getHours() + ":" + f.getMinutes() + ":00";
            var ajuste=0;
			var latitudrecadudo=-1;
			var longitudrecadudo=-1;
			if($('#txtAjuste').val() != ""){
                    ajuste = $('#txtAjuste').val();
                }
			if(localStorage.getItem("latitud") != ""){
				latitudrecadudo = localStorage.getItem("latitud");
			}
			if(localStorage.getItem("longitud") != ""){
				longitudrecadudo = localStorage.getItem("longitud");
			}
			var sql = "INSERT INTO recaudos (CodCliente, CodPrestamo, CodGestor, Fecha, NroCuotas, Ajuste, Latitud, Longitud, Observacion) VALUES ('"+localStorage.getItem("clienteConsultado")+"', '"+localStorage.getItem("codPrestamo")+"', '"+localStorage.getItem("idGestor")+"', '"+fecha+"', '"+$('#txtNumeroCuotas').val()+"', '"+ajuste+"','"+latitudrecadudo+"', '"+longitudrecadudo+"', '"+$('#selectObservacion').val()+"')";	            
			//alert(sql);
			tx.executeSql(sql);
            
            localStorage.setItem("codigoAnterior", localStorage.getItem("clienteConsultado"));
            location.href=location.href;
            //cancelar();

        }

        $(document).ready(function () {		    		    
            localStorage.setItem("latitud", "");
            localStorage.setItem("longitud", "");            
			if(navigator.geolocation){
                var success = function(position){
                    var latitud = position.coords.latitude;
                    var longitud = position.coords.longitude;
                    localStorage.setItem("latitud", latitud);
                    localStorage.setItem("longitud", longitud);
                }
                navigator.geolocation.getCurrentPosition(success, function(msg){
                    
                });
            }else{alert("latitud y longitud no calculada");}
            consultarCliente();
        });
		
    </script>
</body>
</html> 